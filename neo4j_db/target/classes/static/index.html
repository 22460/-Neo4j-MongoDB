<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>甄嬛传人物管理系统</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 自定义Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#64748B',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        info: '#06B6D4',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                transition: all 0.2s ease;
            }
            .btn-hover:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }
            .fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">
<!-- 顶部导航栏 -->
<header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <i class="fa fa-database text-primary text-3xl"></i>
            <h1 class="text-2xl font-bold text-dark">甄嬛传人物管理系统</h1>
        </div>
        <div class="hidden md:flex items-center space-x-6">
            <button id="nav-all" class="text-primary font-medium flex items-center space-x-1 nav-btn active">
                <i class="fa fa-users"></i>
                <span>所有角色</span>
            </button>
            <button id="nav-search" class="text-gray-600 font-medium hover:text-primary transition flex items-center space-x-1 nav-btn">
                <i class="fa fa-search"></i>
                <span>查询角色</span>
            </button>
            <button id="nav-relationship" class="text-gray-600 font-medium hover:text-primary transition flex items-center space-x-1 nav-btn">
                <i class="fa fa-link"></i>
                <span>角色关系</span>
            </button>
            <button id="nav-graph" class="text-gray-600 font-medium hover:text-primary transition flex items-center space-x-1 nav-btn">
                <i class="fa fa-sitemap"></i>
                <span>人物图谱</span>
            </button>
            <button id="nav-messages" class="text-gray-600 font-medium hover:text-primary transition flex items-center space-x-1 nav-btn">
                <i class="fa fa-comments"></i>
                <span>聊天记录</span>
            </button>

        </div>
        <!-- 移动端菜单按钮 -->
        <button id="mobile-menu-btn" class="md:hidden text-gray-600 text-2xl">
            <i class="fa fa-bars"></i>
        </button>
    </div>
    <!-- 移动端导航菜单 -->
    <div id="mobile-menu" class="md:hidden hidden bg-white border-t">
        <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
            <button id="mobile-all" class="text-primary font-medium py-2 px-3 text-left flex items-center space-x-2 border-l-4 border-primary">
                <i class="fa fa-users"></i>
                <span>所有角色</span>
            </button>
            <button id="mobile-search" class="text-gray-600 font-medium py-2 px-3 text-left flex items-center space-x-2 hover:bg-gray-50">
                <i class="fa fa-search"></i>
                <span>查询角色</span>
            </button>
            <button id="mobile-relationship" class="text-gray-600 font-medium py-2 px-3 text-left flex items-center space-x-2 hover:bg-gray-50">
                <i class="fa fa-link"></i>
                <span>角色关系</span>
            </button>
            <button id="mobile-graph" class="text-gray-600 font-medium py-2 px-3 text-left flex items-center space-x-2 hover:bg-gray-50">
                <i class="fa fa-sitemap"></i>
                <span>人物图谱</span>
            </button>
            <button id="mobile-messages" class="text-gray-600 font-medium py-2 px-3 text-left flex items-center space-x-2 hover:bg-gray-50">
                <i class="fa fa-comments"></i>
                <span>聊天记录</span>
            </button>

        </div>
    </div>
</header>

<!-- 主内容区 -->
<main class="container mx-auto px-4 py-8 bg-sky-50 min-h-screen">
    <!-- 回到顶部按钮 -->
    <button id="back-to-top" class="fixed bottom-8 right-8 bg-primary text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center opacity-0 invisible transition-all duration-300 hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50">
        <i class="fa fa-arrow-up"></i>
    </button>
    <!-- 操作结果提示区 -->
    <div id="notification" class="fixed bottom-5 right-5 max-w-sm bg-white rounded-lg shadow-lg p-4 z-50 transform translate-y-20 opacity-0 transition-all duration-300 flex items-start">
        <div id="notification-icon" class="mr-3 text-xl"></div>
        <div>
            <h3 id="notification-title" class="font-bold text-sm"></h3>
            <p id="notification-message" class="text-sm text-gray-600"></p>
        </div>
        <button id="notification-close" class="ml-auto text-gray-400 hover:text-gray-600">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- 人物图谱页面 -->
    <section id="graph-section" class="content-section hidden">
        <div class="bg-white rounded-xl p-6 mb-6 card-shadow">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                <h2 class="text-xl font-bold text-dark">
                    <i class="fa fa-sitemap text-primary mr-2"></i>人物图谱
                </h2>
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="relative">
                        <select id="alliance-filter" class="bg-primary text-white py-2 pl-4 pr-10 rounded-lg border-none focus:ring-2 focus:ring-primary/50 appearance-none cursor-pointer">
                            <option value="all" selected>全部</option>
                            <option value="皇后阵营">皇后阵营</option>
                            <option value="甄嬛阵营">甄嬛阵营</option>
                            <option value="华妃阵营">华妃阵营</option>
                            <option value="皇室成员">皇室成员</option>
                            <option value="无阵营">无阵营</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center justify-center px-2 text-white">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                    <button id="refresh-graph-btn" class="bg-primary text-white py-2 px-6 rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center">
                        <i class="fa fa-refresh mr-2"></i>刷新图谱
                    </button>
                </div>
            </div>

            <!-- 图谱展示区域 -->
            <div class="relative h-[600px] bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                <!-- 加载状态 -->
                <div id="graph-loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mb-4"></div>
                        <p class="text-gray-500">加载人物图谱中...</p>
                    </div>
                </div>

                <!-- 图谱容器 -->
                <div id="graph-container" class="w-full h-full">
                    <!-- 图谱将通过JS动态生成 -->
                </div>

                <!-- 空状态 -->
                <div id="graph-empty" class="absolute inset-0 flex items-center justify-center hidden">
                    <div class="text-center">
                        <i class="fa fa-sitemap text-gray-300 text-6xl mb-4"></i>
                        <p class="text-gray-500">暂无角色数据</p>
                    </div>
                </div>
            </div>

            <!-- 图例说明 -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">图例说明</h3>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-blue-100 border border-blue-300 mr-2"></div>
                        <span class="text-sm">皇后阵营</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-green-100 border border-green-300 mr-2"></div>
                        <span class="text-sm">甄嬛阵营</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-orange-100 border border-orange-300 mr-2"></div>
                        <span class="text-sm">华妃阵营</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-red-100 border border-red-300 mr-2"></div>
                        <span class="text-sm">皇室成员</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-gray-100 border border-gray-300 mr-2"></div>
                        <span class="text-sm">无阵营</span>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-4">提示：点击节点查看角色详情，点击连线查看关系信息</p>
            </div>
        </div>
    </section>

    <!-- 所有角色页面 -->
    <section id="all-persons-section" class="content-section">
        <div class="bg-white rounded-xl p-6 mb-6 card-shadow">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-dark mb-4 md:mb-0">
                    <i class="fa fa-users text-primary mr-2"></i>所有角色
                </h2>
                <div class="flex">
                    <input type="text" id="filter-input" placeholder="搜索角色..."
                           class="w-full md:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <button id="search-persons-btn" class="bg-primary text-white py-2 px-6 rounded-r-lg hover:bg-primary/90 btn-hover">
                        搜索
                    </button>
                </div>
            </div>

            <div id="all-persons-loading" class="hidden py-12 text-center">
                <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                <p class="mt-4 text-gray-500">加载中...</p>
            </div>

            <div id="all-persons-container">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- 角色卡片将通过JS动态生成 -->
                </div>
            </div>

            <div id="all-persons-empty" class="hidden py-16 text-center">
                <i class="fa fa-user-circle-o text-gray-300 text-6xl mb-4"></i>
                <p class="text-gray-500 text-lg">暂无角色数据</p>
            </div>
        </div>
    </section>

    <!-- 查询角色页面 -->
    <section id="search-persons-section" class="content-section hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 搜索表单 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl p-6 card-shadow h-full">
                    <h2 class="text-xl font-bold text-dark mb-6">
                        <i class="fa fa-search text-primary mr-2"></i>查询角色
                    </h2>

                    <!-- 帮助按钮和查询例子卡片 -->
                    <div class="mb-6">
                        <button id="show-examples-btn" class="w-full bg-yellow-50 text-yellow-700 py-3 rounded-lg border border-yellow-200 hover:bg-yellow-100 transition flex items-center justify-center font-medium">
                            <i class="fa fa-lightbulb-o mr-2"></i>
                            查看查询示例
                        </button>
                        
                        <!-- 查询例子资料卡片 - 默认隐藏 -->
                        <div id="examples-card" class="hidden mt-3 bg-blue-50 border border-blue-100 rounded-lg p-4">
                            <div class="space-y-3 text-sm">
                                <div>
                                    <p class="text-blue-700 font-medium">姓名查询示例：</p>
                                    <p class="text-gray-600">甄嬛、雍正、华妃、皇后</p>
                                </div>
                                <div>
                                    <p class="text-blue-700 font-medium">阵营查询示例：</p>
                                    <p class="text-gray-600">甄嬛阵营、皇后阵营、华妃阵营、皇室成员</p>
                                </div>
                                <div>
                                    <p class="text-blue-700 font-medium">称号查询示例：</p>
                                    <p class="text-gray-600">莞常在、华贵妃、皇后、皇上</p>
                                </div>
                                <div>
                                    <p class="text-blue-700 font-medium">介绍查询示例：</p>
                                    <p class="text-gray-600">甄嬛、雍正、华妃</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- 按姓名查询 -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fa fa-user text-info mr-2"></i>按姓名查询
                            </h3>
                            <div class="space-y-3">
                                <input type="text" id="search-by-name" placeholder="输入角色姓名"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                                <button id="search-name-btn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center">
                                    <i class="fa fa-search mr-2"></i>查询
                                </button>
                            </div>
                        </div>

                        <!-- 按阵营查询 -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fa fa-shield text-warning mr-2"></i>按阵营查询
                            </h3>
                            <div class="space-y-3">
                                <input type="text" id="search-by-alliance" placeholder="输入阵营名称"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                                <button id="search-alliance-btn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center">
                                    <i class="fa fa-search mr-2"></i>查询
                                </button>
                            </div>
                        </div>

                        <!-- 按称号查询 -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fa fa-trophy text-success mr-2"></i>按称号查询
                            </h3>
                            <div class="space-y-3">
                                <input type="text" id="search-by-title" placeholder="输入角色称号"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                                <button id="search-title-btn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center">
                                    <i class="fa fa-search mr-2"></i>查询
                                </button>
                            </div>
                        </div>

                        <!-- 获取角色介绍 -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-3 flex items-center">
                                <i class="fa fa-book text-secondary mr-2"></i>获取角色介绍
                            </h3>
                            <div class="space-y-3">
                                <input type="text" id="get-introduction" placeholder="输入角色姓名"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                                <button id="get-intro-btn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center">
                                    <i class="fa fa-file-text-o mr-2"></i>获取介绍
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 查询结果 -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl p-6 card-shadow h-full">
                    <h2 class="text-xl font-bold text-dark mb-6">
                        <i class="fa fa-list-alt text-primary mr-2"></i>查询结果
                    </h2>

                    <div id="search-loading" class="hidden py-12 text-center">
                        <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                        <p class="mt-4 text-gray-500">搜索中...</p>
                    </div>

                    <div id="character-search-results" class="prose max-w-none">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fa fa-search text-gray-300 text-4xl mb-3"></i>
                            <p>请在左侧选择查询条件并输入相关信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 角色关系页面 -->
    <section id="relationship-section" class="content-section hidden">
        <div class="bg-white rounded-xl p-6 card-shadow">
            <h2 class="text-xl font-bold text-dark mb-6">
                <i class="fa fa-link text-primary mr-2"></i>角色关系查询
            </h2>

            <div class="max-w-2xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="md:col-span-1">
                        <label for="person1" class="block text-sm font-medium text-gray-700 mb-1">角色一</label>
                        <input type="text" id="person1" placeholder="输入第一个角色姓名"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                    </div>
                    <div class="md:col-span-1 flex items-end justify-center">
                        <span class="text-xl text-gray-500 font-bold">与</span>
                    </div>
                    <div class="md:col-span-1">
                        <label for="person2" class="block text-sm font-medium text-gray-700 mb-1">角色二</label>
                        <input type="text" id="person2" placeholder="输入第二个角色姓名"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                    </div>
                </div>

                <div class="text-center">
                    <button id="relationship-btn" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary/90 btn-hover inline-flex items-center justify-center">
                        <i class="fa fa-search mr-2"></i>查询关系
                    </button>
                </div>

                <div id="relationship-loading" class="hidden py-12 text-center mt-8">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                    <p class="mt-4 text-gray-500">查询中...</p>
                </div>

                <div id="relationship-results" class="mt-8">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fa fa-handshake-o text-gray-300 text-4xl mb-3"></i>
                        <p>请输入两个角色姓名并点击查询按钮</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 聊天记录页面 -->
    <section id="messages-section" class="content-section hidden">
        <div class="bg-white rounded-xl p-6 mb-6 card-shadow">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-dark mb-4 md:mb-0">
                    <i class="fa fa-comments text-primary mr-2"></i>聊天记录查询
                </h2>
            </div>

            <!-- 聊天记录查询选项卡 -->
            <div class="border-b border-gray-200 mb-6">
                <div class="flex space-x-8 overflow-x-auto">
                    <button id="tab-all-messages" class="pb-3 px-1 border-b-2 border-primary text-primary font-medium flex-shrink-0">
                        所有发言
                    </button>
                    <button id="tab-person-messages" class="pb-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium flex-shrink-0">
                        角色发言
                    </button>
                    <button id="tab-dialogue" class="pb-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium flex-shrink-0">
                        角色对话
                    </button>
                    <button id="tab-scene-messages" class="pb-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium flex-shrink-0">
                        场景发言
                    </button>
                </div>
            </div>

            <!-- 所有发言查询 -->
            <div id="all-messages-content" class="messages-content active">
                <button id="get-all-messages-btn" class="bg-primary text-white py-2 px-6 rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center mb-6">
                    <i class="fa fa-list-alt mr-2"></i>获取所有发言
                </button>

                <div id="all-messages-loading" class="hidden py-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                    <p class="mt-4 text-gray-500">加载中...</p>
                </div>

                <div id="all-messages-container" class="space-y-4">
                    <!-- 消息将通过JS动态生成 -->
                </div>

                <div id="all-messages-empty" class="hidden py-16 text-center">
                    <i class="fa fa-comment-o text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">暂无发言数据</p>
                </div>
            </div>

            <!-- 角色发言查询 -->
            <div id="person-messages-content" class="messages-content hidden">
                <div class="max-w-md mb-6">
                    <label for="person-name-input" class="block text-sm font-medium text-gray-700 mb-2">角色名称</label>
                    <div class="flex">
                        <input type="text" id="person-name-input" placeholder="输入角色名称"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                        <button id="get-person-messages-btn" class="bg-primary text-white py-2 px-6 rounded-r-lg hover:bg-primary/90 btn-hover">
                            查询
                        </button>
                    </div>
                </div>

                <div id="person-messages-loading" class="hidden py-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                    <p class="mt-4 text-gray-500">加载中...</p>
                </div>

                <div id="person-messages-container" class="space-y-4">
                    <!-- 消息将通过JS动态生成 -->
                </div>

                <div id="person-messages-empty" class="hidden py-16 text-center">
                    <i class="fa fa-comment-o text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">该角色暂无发言记录</p>
                </div>
            </div>

            <!-- 角色对话查询 -->
            <div id="dialogue-content" class="messages-content hidden">
                <div class="max-w-2xl mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dialogue-person1" class="block text-sm font-medium text-gray-700 mb-2">角色一</label>
                        <input type="text" id="dialogue-person1" placeholder="输入第一个角色名称"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                    </div>
                    <div>
                        <label for="dialogue-person2" class="block text-sm font-medium text-gray-700 mb-2">角色二</label>
                        <input type="text" id="dialogue-person2" placeholder="输入第二个角色名称"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                    </div>
                </div>

                <button id="get-dialogue-btn" class="bg-primary text-white py-2 px-6 rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center mb-6">
                    <i class="fa fa-exchange mr-2"></i>查询对话
                </button>

                <div id="dialogue-loading" class="hidden py-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                    <p class="mt-4 text-gray-500">加载中...</p>
                </div>

                <div id="dialogue-container" class="max-w-3xl mx-auto space-y-6">
                    <!-- 对话消息将通过JS动态生成 -->
                </div>

                <div id="dialogue-empty" class="hidden py-16 text-center">
                    <i class="fa fa-comments-o text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">这两个角色之间暂无对话记录</p>
                </div>
            </div>

            <!-- 场景发言查询 -->
            <div id="scene-messages-content" class="messages-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <!-- 左侧场景列表 -->
                    <div class="md:col-span-3">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 h-full">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">选择场景</h3>
                            </div>
                            <!-- 搜索框 -->
                            <div class="p-3 border-b border-gray-100">
                                <div class="relative">
                                    <input type="text" id="scene-search-input"
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                                        placeholder="搜索场景..."
                                        autocomplete="off">
                                    <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            <!-- 加载状态 -->
                            <div id="scenes-loading" class="hidden py-8 text-center">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                                <p class="mt-2 text-gray-500 text-sm">加载中...</p>
                            </div>
                            <!-- 搜索结果区域 -->
                            <div id="search-results" class="hidden p-2 border-b border-gray-200 bg-white">
                                <div class="text-xs text-gray-500 mb-2 font-medium">搜索结果</div>
                                <div id="search-results-list"></div>
                            </div>
                            <!-- 场景列表 -->
                            <div id="scenes-list" class="p-2 max-h-[60vh] overflow-y-auto">
                                <!-- 场景列表会在这里动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧发言内容 -->
                    <div class="md:col-span-9">
                        <!-- 选中的场景信息 -->
                        <div id="selected-scene-info" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800">当前场景：<span id="selected-scene-name" class="font-bold"></span></h4>
                        </div>
                        
                        <!-- 加载状态 -->
                        <div id="scene-messages-loading" class="hidden py-16 text-center">
                            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent"></div>
                            <p class="mt-4 text-gray-500">加载中...</p>
                        </div>
                        
                        <!-- 初始提示 -->
                        <div id="scene-messages-initial" class="py-16 text-center text-gray-500">
                            <i class="fa fa-map-marker text-gray-300 text-6xl mb-4"></i>
                            <p class="text-lg mb-2">请从左侧选择一个场景</p>
                            <p class="text-sm">点击场景按钮查看该场景下的所有发言</p>
                        </div>
                        
                        <!-- 结果容器 -->
                        <div id="scene-messages-container" class="space-y-4 hidden">
                            <!-- 消息将通过JS动态生成 -->
                        </div>
                        
                        <!-- 空状态 -->
                        <div id="scene-messages-empty" class="hidden py-16 text-center text-gray-500">
                            <i class="fa fa-comment-o text-gray-300 text-6xl mb-4"></i>
                            <p class="text-lg">该场景暂无发言记录</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


</main>

<!-- 页脚 -->
<footer class="bg-white border-t mt-12 py-8">
    <div class="container mx-auto px-4 text-center text-gray-600">
        <p>© 2024 甄嬛传人物管理系统</p>
        <p class="mt-2 text-sm">基于Spring Boot和Neo4j构建</p>
    </div>
</footer>

<!-- 角色详情模态框 -->
<div id="person-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b">
            <div class="flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-dark"></h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-xl">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div id="modal-content"></div>
        </div>
        <div class="p-6 border-t bg-gray-50 flex justify-between">
            <div class="space-x-3">

            </div>
        </div>
    </div>
</div>

<!-- 编辑模态框 -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full">
        <div class="p-6 border-b">
            <div class="flex justify-between items-center">
                <h3 id="edit-modal-title" class="text-xl font-bold text-dark"></h3>
                <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 text-xl">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-person-id">
                <input type="hidden" id="edit-person-name">
                <input type="hidden" id="edit-type">
                <div>
                    <label id="edit-field-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="text" id="edit-field-value"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
                </div>
                <div class="pt-2">
                    <button type="submit" class="w-full px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-hover flex items-center justify-center">
                        <i class="fa fa-save mr-2"></i>保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // 基础URL
    const BASE_URL = 'http://localhost:8081/api/persons';
    let currentPerson = null;

    // DOM元素
    const elements = {
        // 导航
        navButtons: document.querySelectorAll('.nav-btn'),
        mobileMenuBtn: document.getElementById('mobile-menu-btn'),
        mobileMenu: document.getElementById('mobile-menu'),
        mobileNavButtons: document.querySelectorAll('[id^="mobile-"]'),

        // 内容区域
        sections: document.querySelectorAll('.content-section'),
        
        // 人物图谱页面
        refreshGraphBtn: document.getElementById('refresh-graph-btn'),
        graphContainer: document.getElementById('graph-container'),
        graphLoading: document.getElementById('graph-loading'),
        graphEmpty: document.getElementById('graph-empty'),

        // 所有角色页面
        filterInput: document.getElementById('filter-input'),
        searchPersonsBtn: document.getElementById('search-persons-btn'),
        allPersonsContainer: document.getElementById('all-persons-container'),
        allPersonsLoading: document.getElementById('all-persons-loading'),
        allPersonsEmpty: document.getElementById('all-persons-empty'),

        // 搜索页面
        searchNameBtn: document.getElementById('search-name-btn'),
        searchByName: document.getElementById('search-by-name'),
        searchAllianceBtn: document.getElementById('search-alliance-btn'),
        searchByAlliance: document.getElementById('search-by-alliance'),
        searchTitleBtn: document.getElementById('search-title-btn'),
        searchByTitle: document.getElementById('search-by-title'),
        getIntroBtn: document.getElementById('get-intro-btn'),
        getIntroduction: document.getElementById('get-introduction'),
        searchResults: document.getElementById('character-search-results'),
        searchLoading: document.getElementById('search-loading'),

        // 关系页面
        relationshipBtn: document.getElementById('relationship-btn'),
        person1: document.getElementById('person1'),
        person2: document.getElementById('person2'),
        relationshipResults: document.getElementById('relationship-results'),
        relationshipLoading: document.getElementById('relationship-loading'),

        // 添加角色页面

        resetFormBtn: document.getElementById('reset-form-btn'),

        // 模态框
        personModal: document.getElementById('person-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalContent: document.getElementById('modal-content'),
        closeModal: document.getElementById('close-modal'),

        editAllianceBtn: document.getElementById('edit-alliance-btn'),
        editTitleBtn: document.getElementById('edit-title-btn'),

        // 编辑模态框
        editModal: document.getElementById('edit-modal'),
        editModalTitle: document.getElementById('edit-modal-title'),
        editForm: document.getElementById('edit-form'),
        editPersonId: document.getElementById('edit-person-id'),
        editPersonName: document.getElementById('edit-person-name'),
        editType: document.getElementById('edit-type'),
        editFieldLabel: document.getElementById('edit-field-label'),
        editFieldValue: document.getElementById('edit-field-value'),
        closeEditModal: document.getElementById('close-edit-modal'),

        // 通知
        notification: document.getElementById('notification'),
        notificationIcon: document.getElementById('notification-icon'),
        notificationTitle: document.getElementById('notification-title'),
        notificationMessage: document.getElementById('notification-message'),
        notificationClose: document.getElementById('notification-close')
    };

    // 初始化
    function init() {
        // 加载所有角色
        loadAllPersons();

        // 绑定导航事件
        bindNavigationEvents();

        // 绑定搜索事件
        bindSearchEvents();

        // 绑定关系查询事件
        bindRelationshipEvents();

        // 绑定人物图谱事件
        bindGraphEvents();

        // 绑定模态框事件
        bindModalEvents();

        // 绑定通知事件
        bindNotificationEvents();
        
        // 绑定查询示例按钮事件
        bindExampleButtonEvents();
    }

    // 加载所有角色
    async function loadAllPersons() {
        elements.allPersonsLoading.classList.remove('hidden');
        elements.allPersonsEmpty.classList.add('hidden');
        elements.allPersonsContainer.innerHTML = '';

        try {
            const response = await fetch(`${BASE_URL}/all`);
            const persons = await response.json();

            elements.allPersonsLoading.classList.add('hidden');

            if (persons.length === 0) {
                elements.allPersonsEmpty.classList.remove('hidden');
            } else {
                renderPersons(persons);

                // 绑定搜索按钮点击事件
                elements.searchPersonsBtn.addEventListener('click', () => {
                    const searchTerm = elements.filterInput.value.toLowerCase();
                    const filteredPersons = persons.filter(person =>
                        person.name.toLowerCase().includes(searchTerm) ||
                        person.alliance?.toLowerCase().includes(searchTerm) ||
                        person.title?.toLowerCase().includes(searchTerm)
                    );
                    renderPersons(filteredPersons);
                });
            }
        } catch (error) {
            elements.allPersonsLoading.classList.add('hidden');
            showNotification('错误', '加载角色失败: ' + error.message, 'error');
        }
    }

    // 渲染角色列表
    function renderPersons(persons) {
        elements.allPersonsContainer.innerHTML = '';

        if (persons.length === 0) {
            elements.allPersonsEmpty.classList.remove('hidden');
            return;
        }

        elements.allPersonsEmpty.classList.add('hidden');

        persons.forEach(person => {
            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition cursor-pointer';
            card.setAttribute('data-person-id', person.id);
            card.setAttribute('data-person-name', person.name);

            let allianceColor = 'bg-gray-100 text-gray-600';
             if (person.alliance) {
                 if (person.alliance.includes('皇后阵营')) {
                     allianceColor = 'bg-blue-100 text-blue-700';
                 } else if (person.alliance.includes('甄嬛阵营')) {
                     allianceColor = 'bg-green-100 text-green-700';
                 } else if (person.alliance.includes('华妃阵营')) {
                     allianceColor = 'bg-orange-100 text-orange-700';
                 } else if (person.alliance.includes('皇室成员')) {
                     allianceColor = 'bg-red-100 text-red-700';
                 }
            }

            card.innerHTML = `
                    <div class="p-5">
                        <h3 class="text-lg font-bold text-dark mb-3">${person.name}</h3>
                        
                        <!-- 红框部分：ID、所属阵营、角色称号横向排列 -->
                        <div class="flex flex-wrap gap-3 mb-3">
                            <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">ID: ${person.id}</span>
                            ${person.alliance ?
                `<span class="px-3 py-1 text-xs font-medium rounded-full ${allianceColor}">${person.alliance}</span>` :
                '<span class="px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">无阵营</span>'
            }
                            ${person.title ?
                `<span class="px-3 py-1 text-xs bg-yellow-50 text-yellow-700 rounded-full">
                                <i class="fa fa-trophy text-yellow-500 mr-1"></i>${person.title}
                            </span>` : ''
            }
                        </div>

                        <!-- 角色介绍垂直排列 -->
                        <div class="text-sm text-gray-500 line-clamp-2">
                            ${person.introduction || '暂无介绍'}
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 py-3 border-t border-gray-200 flex justify-end">
                        <button class="text-primary hover:text-primary/80 text-sm font-medium">
                            查看详情
                        </button>
                    </div>
                `;

            card.addEventListener('click', () => {
                openPersonDetails(person);
            });

            elements.allPersonsContainer.appendChild(card);
        });
    }

    // 根据阵营获取对应的CSS颜色类
    function getAllianceColorClass(alliance) {
        if (alliance.includes('皇后阵营')) {
            return 'bg-blue-100 text-blue-700';
        } else if (alliance.includes('甄嬛阵营')) {
            return 'bg-green-100 text-green-700';
        } else if (alliance.includes('华妃阵营')) {
            return 'bg-orange-100 text-orange-700';
        } else if (alliance.includes('皇室成员')) {
            return 'bg-red-100 text-red-700';
        }
        return 'bg-gray-100 text-gray-700'; // 默认颜色
    }

    // 打开角色详情模态框
    function openPersonDetails(person) {
        currentPerson = person;
        elements.modalTitle.textContent = person.name;

        let allianceHtml = person.alliance ?
            `<div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-500 mb-1">所属阵营</h4>
                    <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${getAllianceColorClass(person.alliance)}">${person.alliance}</span>
                </div>` : '';

        let titleHtml = person.title ?
            `<div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-500 mb-1">角色称号</h4>
                    <p class="font-medium">${person.title}</p>
                </div>` : '';

        elements.modalContent.innerHTML = `
                <div>
                    <!-- 红框部分：ID、所属阵营、角色称号横向排列 -->
                    <div class="flex flex-wrap gap-4 mb-4">
                        <div class="flex-1 min-w-[100px]">
                            <h4 class="text-sm font-medium text-gray-500 mb-1">ID</h4>
                            <p>${person.id}</p>
                        </div>
                        ${allianceHtml ? `<div class="flex-1 min-w-[150px]">${allianceHtml.replace(/^<div class="mb-4">/g, '').replace(/<\/div>$/g, '')}</div>` : ''}
                        ${titleHtml ? `<div class="flex-1 min-w-[150px]">${titleHtml.replace(/^<div class="mb-4">/g, '').replace(/<\/div>$/g, '')}</div>` : ''}
                    </div>
                    
                    <!-- 角色介绍垂直排列 -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">角色介绍</h4>
                        <p class="whitespace-pre-line">${person.introduction || '暂无介绍'}</p>
                    </div>
                </div>
            `;

        elements.personModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // 绑定导航事件
    function bindNavigationEvents() {
        // 桌面导航
        elements.navButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.currentTarget.id.replace('nav-', '');
                showSection(targetId);
            });
        });

        // 移动端菜单
        elements.mobileMenuBtn.addEventListener('click', () => {
            elements.mobileMenu.classList.toggle('hidden');
        });

        // 移动端导航
        elements.mobileNavButtons.forEach(button => {
            if (button.id !== 'mobile-menu-btn') {
                button.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.id.replace('mobile-', '');
                    showSection(targetId);
                    elements.mobileMenu.classList.add('hidden');
                });
            }
        });
    }

    // 显示指定区域
        function showSection(sectionId) {
            // 隐藏所有区域
            elements.sections.forEach(section => {
                section.classList.add('hidden');
            });

            // 激活指定区域
            let targetSection;
            switch (sectionId) {
                case 'all':
                    targetSection = document.getElementById('all-persons-section');
                    break;
                case 'search':
                    targetSection = document.getElementById('search-persons-section');
                    break;
                case 'relationship':
                    targetSection = document.getElementById('relationship-section');
                    break;
                case 'graph':
                    targetSection = document.getElementById('graph-section');
                    loadPersonGraph(); // 加载人物图谱
                    break;
                case 'messages':
                    targetSection = document.getElementById('messages-section');
                    break;
                case 'add':
                    targetSection = document.getElementById('add-persons-section');
                    break;
            }

        if (targetSection) {
            targetSection.classList.remove('hidden');
            targetSection.classList.add('fade-in');
        }

        // 更新导航高亮
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-primary');
            btn.classList.add('text-gray-600');
        });

        const activeNavBtn = document.getElementById(`nav-${sectionId}`);
        if (activeNavBtn) {
            activeNavBtn.classList.remove('text-gray-600');
            activeNavBtn.classList.add('text-primary');
        }

        // 更新移动端导航高亮
        document.querySelectorAll('[id^="mobile-"]').forEach(btn => {
            if (btn.id !== 'mobile-menu-btn') {
                btn.classList.remove('text-primary', 'border-l-4', 'border-primary');
                btn.classList.add('text-gray-600');
            }
        });

        const activeMobileBtn = document.getElementById(`mobile-${sectionId}`);
        if (activeMobileBtn) {
            activeMobileBtn.classList.remove('text-gray-600');
            activeMobileBtn.classList.add('text-primary', 'border-l-4', 'border-primary');
        }
    }

    // 绑定搜索事件
    function bindSearchEvents() {
        // 按姓名搜索
        elements.searchNameBtn.addEventListener('click', async () => {
            const name = elements.searchByName.value.trim();
            if (!name) {
                showNotification('提示', '请输入角色姓名', 'info');
                return;
            }

            elements.searchLoading.classList.remove('hidden');

            try {
                const response = await fetch(`${BASE_URL}/name/${name}`);

                if (response.status === 404) {
                    elements.searchResults.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fa fa-search text-gray-300 text-4xl mb-3"></i>
                                <p>未找到名为 "${name}" 的角色</p>
                            </div>
                        `;
                } else if (response.ok) {
                    const person = await response.json();
                    renderSearchResultPerson(person);
                } else {
                    throw new Error('搜索失败');
                }
            } catch (error) {
                showNotification('错误', '搜索失败: ' + error.message, 'error');
            } finally {
                elements.searchLoading.classList.add('hidden');
            }
        });

        // 按阵营搜索
        elements.searchAllianceBtn.addEventListener('click', async () => {
            const alliance = elements.searchByAlliance.value.trim();
            if (!alliance) {
                showNotification('提示', '请输入阵营名称', 'info');
                return;
            }

            elements.searchLoading.classList.remove('hidden');

            try {
                // 使用encodeURIComponent确保URL参数正确编码
                const response = await fetch(`${BASE_URL}/alliance/${encodeURIComponent(alliance)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const persons = await response.json();

                if (persons.length === 0) {
                    elements.searchResults.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fa fa-users text-gray-300 text-4xl mb-3"></i>
                                <p>未找到包含 "${alliance}" 的阵营角色</p>
                                <p class="text-sm mt-2 text-gray-400">请尝试使用：皇后阵营、甄嬛阵营、华妃阵营、皇室成员</p>
                            </div>
                        `;
                } else {
                    // 显示找到的结果数量
                    showNotification('成功', `找到 ${persons.length} 位属于该阵营的角色`, 'success');
                    renderSearchResultPersons(persons);
                }
            } catch (error) {
                showNotification('错误', '搜索失败: ' + error.message, 'error');
                elements.searchResults.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <i class="fa fa-exclamation-circle text-4xl mb-3"></i>
                        <p>查询过程中出现错误，请稍后重试</p>
                    </div>
                `;
            } finally {
                elements.searchLoading.classList.add('hidden');
            }
        });

        // 按称号搜索
        elements.searchTitleBtn.addEventListener('click', async () => {
            const title = elements.searchByTitle.value.trim();
            if (!title) {
                showNotification('提示', '请输入角色称号', 'info');
                return;
            }

            elements.searchLoading.classList.remove('hidden');

            try {
                const response = await fetch(`${BASE_URL}/title/${title}`);
                const persons = await response.json();

                if (persons.length === 0) {
                    elements.searchResults.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fa fa-trophy text-gray-300 text-4xl mb-3"></i>
                                <p>未找到称号为 "${title}" 的角色</p>
                            </div>
                        `;
                } else {
                    renderSearchResultPersons(persons);
                }
            } catch (error) {
                showNotification('错误', '搜索失败: ' + error.message, 'error');
            } finally {
                elements.searchLoading.classList.add('hidden');
            }
        });

        // 获取角色介绍
        elements.getIntroBtn.addEventListener('click', async () => {
            const name = elements.getIntroduction.value.trim();
            if (!name) {
                showNotification('提示', '请输入角色姓名', 'info');
                return;
            }

            elements.searchLoading.classList.remove('hidden');

            try {
                const response = await fetch(`${BASE_URL}/introduction/${name}`);

                if (response.status === 400) {
                    const errorMessage = await response.text();
                    elements.searchResults.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fa fa-exclamation-circle text-gray-300 text-4xl mb-3"></i>
                                <p>${errorMessage}</p>
                            </div>
                        `;
                } else if (response.ok) {
                    const introduction = await response.text();
                    elements.searchResults.innerHTML = `
                            <div class="p-6 bg-gray-50 rounded-lg">
                                <h3 class="text-lg font-bold text-dark mb-3">${name} 的角色介绍</h3>
                                <div class="prose max-w-none">
                                    <p class="whitespace-pre-line">${introduction}</p>
                                </div>
                            </div>
                        `;
                } else {
                    throw new Error('获取介绍失败');
                }
            } catch (error) {
                showNotification('错误', '获取介绍失败: ' + error.message, 'error');
            } finally {
                elements.searchLoading.classList.add('hidden');
            }
        });
    }

    // 渲染单个角色搜索结果
    function renderSearchResultPerson(person) {
        elements.searchResults.innerHTML = `
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition cursor-pointer">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-dark mb-4">${person.name}</h3>

                        <div>
                            <!-- 红框部分：ID、所属阵营、角色称号横向排列 -->
                            <div class="flex flex-wrap gap-4 mb-4">
                                <div class="flex-1 min-w-[100px]">
                                    <h4 class="text-sm font-medium text-gray-500 mb-1">ID</h4>
                                    <p>${person.id}</p>
                                </div>
                                ${person.alliance ?
            `<div class="flex-1 min-w-[150px]">
                                    <h4 class="text-sm font-medium text-gray-500 mb-1">所属阵营</h4>
                                    <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${getAllianceColorClass(person.alliance)}">${person.alliance}</span>
                                </div>` : ''
        }

                                ${person.title ?
            `<div class="flex-1 min-w-[150px]">
                                    <h4 class="text-sm font-medium text-gray-500 mb-1">角色称号</h4>
                                    <p class="font-medium">${person.title}</p>
                                </div>` : ''
        }
                            </div>
                            
                            <!-- 角色介绍垂直排列 -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-500 mb-1">角色介绍</h4>
                                <p class="whitespace-pre-line">${person.introduction || '暂无介绍'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        elements.searchResults.querySelector('div').addEventListener('click', () => {
            openPersonDetails(person);
        });
    }

    // 渲染角色列表搜索结果
    function renderSearchResultPersons(persons) {
        elements.searchResults.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${persons.map(person => `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer"
                             data-person-id="${person.id}" data-person-name="${person.name}">
                            <h3 class="font-bold text-dark mb-2">${person.name}</h3>
                            ${person.alliance ?
            `<div class="text-sm mb-1">
                                    <span class="text-gray-500">阵营:</span> <span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${getAllianceColorClass(person.alliance)}">${person.alliance}</span>
                                </div>` : ''
        }
                            ${person.title ?
            `<div class="text-sm text-gray-600 mb-1">
                                    <span class="text-gray-500">称号:</span> ${person.title}
                                </div>` : ''
        }
                            <div class="text-xs text-gray-500">ID: ${person.id}</div>
                        </div>
                    `).join('')}
                </div>
            `;

        // 为每个角色卡片绑定点击事件
        elements.searchResults.querySelectorAll('[data-person-id]').forEach(card => {
            card.addEventListener('click', async () => {
                const personName = card.getAttribute('data-person-name');
                try {
                    const response = await fetch(`${BASE_URL}/name/${personName}`);
                    if (response.ok) {
                        const person = await response.json();
                        openPersonDetails(person);
                    }
                } catch (error) {
                    showNotification('错误', '获取角色详情失败', 'error');
                }
            });
        });
    }

    // 绑定关系查询事件
    function bindRelationshipEvents() {
        elements.relationshipBtn.addEventListener('click', async () => {
            const name1 = elements.person1.value.trim();
            const name2 = elements.person2.value.trim();

            if (!name1 || !name2) {
                showNotification('提示', '请输入两个角色姓名', 'info');
                return;
            }

            elements.relationshipLoading.classList.remove('hidden');

            try {
                const response = await fetch(`${BASE_URL}/relationship/${name1}/${name2}`);
                const result = await response.json();

                elements.relationshipResults.innerHTML = '';

                if (typeof result === 'string') {
                    // 没有找到关系
                    elements.relationshipResults.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fa fa-chain-broken text-gray-300 text-4xl mb-3"></i>
                                <p>${result}</p>
                            </div>
                        `;
                } else if (Array.isArray(result) && result.length > 0) {
                    // 找到关系
                    elements.relationshipResults.innerHTML = `
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-lg font-bold text-dark mb-4">${name1} 和 ${name2} 之间的关系</h3>
                                <div class="space-y-3">
                                    ${result.map(rel => {
                        // 为关系行添加不同的颜色
                        let colorClass = 'bg-blue-100 border-blue-200';
                        if (rel.includes('朋友')) colorClass = 'bg-green-100 border-green-200';
                        else if (rel.includes('敌人')) colorClass = 'bg-red-100 border-red-200';
                        else if (rel.includes('家人')) colorClass = 'bg-yellow-100 border-yellow-200';

                        return `
                                            <div class="p-3 rounded-lg border ${colorClass} flex items-center">
                                                <i class="fa fa-long-arrow-right text-primary mx-4"></i>
                                                <span class="font-medium">${rel}</span>
                                            </div>
                                        `;
                    }).join('')}
                                </div>
                            </div>
                        `;
                }
            } catch (error) {
                showNotification('错误', '查询关系失败: ' + error.message, 'error');
            } finally {
                elements.relationshipLoading.classList.add('hidden');
            }
        });
    }



    // 绑定模态框事件
    function bindModalEvents() {
        // 关闭详情模态框
        elements.closeModal.addEventListener('click', () => {
            elements.personModal.classList.add('hidden');
            document.body.style.overflow = '';
        });

        // 点击模态框外部关闭
        elements.personModal.addEventListener('click', (e) => {
            if (e.target === elements.personModal) {
                elements.personModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });



        // 编辑阵营和称号功能已移除

        // 关闭编辑模态框
        elements.closeEditModal.addEventListener('click', () => {
            elements.editModal.classList.add('hidden');
        });

        // 点击编辑模态框外部关闭
        elements.editModal.addEventListener('click', (e) => {
            if (e.target === elements.editModal) {
                elements.editModal.classList.add('hidden');
            }
        });

        // 提交编辑表单
        elements.editForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const personId = elements.editPersonId.value;
            const personName = elements.editPersonName.value;
            const editType = elements.editType.value;
            const newValue = elements.editFieldValue.value.trim();

            if (!newValue) {
                showNotification('提示', '请输入新值', 'info');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/${personId}/${editType}?new${editType.charAt(0).toUpperCase() + editType.slice(1)}=${encodeURIComponent(newValue)}`, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    const updatedPerson = await response.json();
                    currentPerson = updatedPerson;
                    showNotification('成功', `成功更新 ${personName} 的${editType === 'alliance' ? '阵营' : '称号'}`, 'success');
                    elements.editModal.classList.add('hidden');

                    // 更新模态框内容
                    openPersonDetails(updatedPerson);

                    // 刷新列表
                    loadAllPersons();
                } else if (response.status === 404) {
                    showNotification('错误', '未找到该角色，可能已被删除', 'error');
                    elements.editModal.classList.add('hidden');
                    elements.personModal.classList.add('hidden');
                } else {
                    throw new Error('更新失败');
                }
            } catch (error) {
                showNotification('错误', '更新失败: ' + error.message, 'error');
            }
        });
    }

    // 绑定通知事件
    function bindNotificationEvents() {
        elements.notificationClose.addEventListener('click', () => {
            hideNotification();
        });
    }

    // 显示通知
    function showNotification(title, message, type = 'info') {
        elements.notificationTitle.textContent = title;
        elements.notificationMessage.textContent = message;

        // 设置图标和颜色
        elements.notificationIcon.className = 'mr-3 text-xl';

        switch (type) {
            case 'success':
                elements.notificationIcon.innerHTML = '<i class="fa fa-check-circle text-success"></i>';
                elements.notification.classList.remove('bg-red-50', 'bg-yellow-50', 'bg-blue-50');
                elements.notification.classList.add('bg-green-50');
                break;
            case 'error':
                elements.notificationIcon.innerHTML = '<i class="fa fa-exclamation-circle text-danger"></i>';
                elements.notification.classList.remove('bg-green-50', 'bg-yellow-50', 'bg-blue-50');
                elements.notification.classList.add('bg-red-50');
                break;
            case 'warning':
                elements.notificationIcon.innerHTML = '<i class="fa fa-exclamation-triangle text-warning"></i>';
                elements.notification.classList.remove('bg-green-50', 'bg-red-50', 'bg-blue-50');
                elements.notification.classList.add('bg-yellow-50');
                break;
            default:
                elements.notificationIcon.innerHTML = '<i class="fa fa-info-circle text-info"></i>';
                elements.notification.classList.remove('bg-green-50', 'bg-red-50', 'bg-yellow-50');
                elements.notification.classList.add('bg-blue-50');
        }

        // 显示通知
        elements.notification.classList.remove('translate-y-20', 'opacity-0');

        // 自动隐藏
        setTimeout(hideNotification, 5000);
    }

    // 隐藏通知
        function hideNotification() {
            elements.notification.classList.add('translate-y-20', 'opacity-0');
        }

        // 绑定查询示例按钮事件
        function bindExampleButtonEvents() {
            const showExamplesBtn = document.getElementById('show-examples-btn');
            const examplesCard = document.getElementById('examples-card');
            
            if (showExamplesBtn && examplesCard) {
                showExamplesBtn.addEventListener('click', () => {
                    examplesCard.classList.toggle('hidden');
                    // 更新按钮文本
                    if (examplesCard.classList.contains('hidden')) {
                        showExamplesBtn.innerHTML = '<i class="fa fa-lightbulb-o mr-2"></i>查看查询示例';
                    } else {
                        showExamplesBtn.innerHTML = '<i class="fa fa-times-circle mr-2"></i>隐藏查询示例';
                    }
                });
            }
        }

        // 绑定人物图谱事件
        function bindGraphEvents() {
            elements.refreshGraphBtn.addEventListener('click', loadPersonGraph);
            // 为阵营筛选下拉框添加事件监听器
            document.getElementById('alliance-filter').addEventListener('change', loadPersonGraph);
        }

        // 加载人物图谱
        async function loadPersonGraph() {
            elements.graphLoading.classList.remove('hidden');
            elements.graphEmpty.classList.add('hidden');
            elements.graphContainer.innerHTML = '';
            
            // 获取选中的阵营
            const selectedAlliance = document.getElementById('alliance-filter').value;

            try {
                // 首先加载所有角色
                const personsResponse = await fetch(`${BASE_URL}/all`);
                let persons = await personsResponse.json();
                
                // 如果选择了特定阵营，则筛选数据
                if (selectedAlliance !== 'all') {
                    persons = persons.filter(person => {
                        // 确保person.alliance存在且为字符串
                        const allianceStr = person.alliance ? String(person.alliance).toLowerCase() : '';
                        return allianceStr.includes(selectedAlliance.toLowerCase());
                    });
                }

                // 加载角色间关系
                let allRelationships = [];
                // 为简化实现，这里假设我们有一个API可以获取所有关系
                // 实际项目中可能需要根据需求调整获取关系的方式
                try {
                    const relationshipsResponse = await fetch(`${BASE_URL}/allRelationships`);
                    if (relationshipsResponse.ok) {
                        allRelationships = await relationshipsResponse.json();
                    }
                } catch (error) {
                    console.log('未找到获取所有关系的API，将使用模拟数据', error);
                    // 使用模拟关系数据
                    allRelationships = generateMockRelationships(persons);
                }

                elements.graphLoading.classList.add('hidden');

                if (persons.length === 0) {
                    elements.graphEmpty.classList.remove('hidden');
                } else {
                    renderPersonGraph(persons, allRelationships);
                }
            } catch (error) {
                elements.graphLoading.classList.add('hidden');
                showNotification('错误', '加载人物图谱失败: ' + error.message, 'error');
            }
        }

        // 渲染人物图谱
        function renderPersonGraph(persons, relationships) {
            // 定义节点拖拽状态变量
            let nodeIsDragging = false;
            
            // 创建图谱SVG容器
            const containerWidth = elements.graphContainer.offsetWidth;
            const containerHeight = elements.graphContainer.offsetHeight;
            const graphPadding = 50;

            // 创建SVG元素
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('viewBox', `0 0 ${containerWidth} ${containerHeight}`);
            elements.graphContainer.appendChild(svg);

            // 定义箭头标记
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto-start-reverse');
            
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', '#94a3b8');
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);

            // 节点半径和链接配置
            const nodeRadius = 25; // 稍微减小节点大小以减少重叠
            // 使用所有关系
            const links = relationships;

            // 计算节点位置 - 使用简化的力导向布局
            const centerX = containerWidth / 2;
            const centerY = containerHeight / 2;
            
            // 为每个角色分配随机初始位置
            const nodeMap = new Map();
            const nodes = [];
            
            persons.forEach((person, index) => {
                // 在容器内随机分配初始位置，但避开边缘
                const x = graphPadding + Math.random() * (containerWidth - 2 * graphPadding);
                const y = graphPadding + Math.random() * (containerHeight - 2 * graphPadding);
                
                const node = { x, y, person, vx: 0, vy: 0 };
                nodes.push(node);
                nodeMap.set(person.name, node);
            });
            
            // 力导向布局配置 - 优化以减少重叠
            const forceConfig = {
                charge: -3500, // 大幅增加节点间排斥力，进一步减少重叠
                linkDistance: 300, // 大幅增加理想链接距离，让节点分布更开
                gravity: 0.03, // 进一步减小向中心的引力，允许节点分布更广
                friction: 0.9, // 增加摩擦力，使布局更稳定
                iterations: 300 // 增加迭代次数，让布局更充分展开
            };
            
            // 简单的力导向模拟
            function simulateForceLayout() {
                for (let iter = 0; iter < forceConfig.iterations; iter++) {
                    // 重置速度
                    nodes.forEach(node => {
                        node.vx *= forceConfig.friction;
                        node.vy *= forceConfig.friction;
                    });
                    
                    // 1. 应用节点间排斥力
                    for (let i = 0; i < nodes.length; i++) {
                        for (let j = i + 1; j < nodes.length; j++) {
                            const nodeA = nodes[i];
                            const nodeB = nodes[j];
                            
                            const dx = nodeA.x - nodeB.x;
                            const dy = nodeA.y - nodeB.y;
                            const distance = Math.sqrt(dx * dx + dy * dy) || 0.1;
                            
                            // 避免除零错误并计算排斥力
                            if (distance < 2 * nodeRadius) {
                                const force = (forceConfig.charge * 2) / (distance * distance);
                                const fx = (dx / distance) * force;
                                const fy = (dy / distance) * force;
                                
                                nodeA.vx += fx;
                                nodeA.vy += fy;
                                nodeB.vx -= fx;
                                nodeB.vy -= fy;
                            }
                        }
                    }
                    
                    // 2. 应用连接力（关系）
                    links.forEach(rel => {
                        if (nodeMap.has(rel.person1) && nodeMap.has(rel.person2)) {
                            const nodeA = nodeMap.get(rel.person1);
                            const nodeB = nodeMap.get(rel.person2);
                            
                            const dx = nodeA.x - nodeB.x;
                            const dy = nodeA.y - nodeB.y;
                            const distance = Math.sqrt(dx * dx + dy * dy) || 0.1;
                            
                            // 计算弹簧力
                            const force = (distance - forceConfig.linkDistance) * 0.1;
                            const fx = (dx / distance) * force;
                            const fy = (dy / distance) * force;
                            
                            nodeA.vx -= fx;
                            nodeA.vy -= fy;
                            nodeB.vx += fx;
                            nodeB.vy += fy;
                        }
                    });
                    
                    // 3. 应用中心引力
                    nodes.forEach(node => {
                        const dx = centerX - node.x;
                        const dy = centerY - node.y;
                        
                        node.vx += dx * forceConfig.gravity;
                        node.vy += dy * forceConfig.gravity;
                    });
                    
                    // 4. 更新位置
                    nodes.forEach(node => {
                        node.x += node.vx;
                        node.y += node.vy;
                        
                        // 边界检查
                        node.x = Math.max(graphPadding + nodeRadius, Math.min(containerWidth - graphPadding - nodeRadius, node.x));
                        node.y = Math.max(graphPadding + nodeRadius, Math.min(containerHeight - graphPadding - nodeRadius, node.y));
                    });
                }
            }
            
            // 运行力导向模拟
            simulateForceLayout();

            // 绘制连线 - 使用path代替line以支持箭头
            // 创建连线组，放在节点组下方
            const linksGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            linksGroup.setAttribute('class', 'links-group');
            svg.appendChild(linksGroup);
            
            // 存储所有连线元素
            const linkElements = [];
            
            links.forEach(rel => {
                if (nodeMap.has(rel.person1) && nodeMap.has(rel.person2)) {
                    const node1 = nodeMap.get(rel.person1);
                    const node2 = nodeMap.get(rel.person2);
                    
                    // 计算连线方向和距离
                    const dx = node2.x - node1.x;
                    const dy = node2.y - node1.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // 计算线条终点位置，避免直接连接到节点中心
                    const startX = node1.x + (dx / distance) * nodeRadius;
                    const startY = node1.y + (dy / distance) * nodeRadius;
                    const endX = node2.x - (dx / distance) * nodeRadius;
                    const endY = node2.y - (dy / distance) * nodeRadius;
                    
                    // 创建路径元素 - 使用稍微弯曲的线条更自然
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    // 添加轻微的弯曲效果
                    const midX = (startX + endX) / 2 + (Math.random() - 0.5) * 20;
                    const midY = (startY + endY) / 2 + (Math.random() - 0.5) * 20;
                    const pathData = `M ${startX} ${startY} Q ${midX} ${midY} ${endX} ${endY}`;
                    
                    path.setAttribute('d', pathData);
                    path.setAttribute('stroke', '#94a3b8');
                    path.setAttribute('stroke-width', '1.2');
                    path.setAttribute('stroke-opacity', '0.7');
                    path.setAttribute('fill', 'none');
                    path.setAttribute('marker-end', 'url(#arrowhead)'); // 添加箭头
                    path.setAttribute('data-rel-type', rel.relationshipType || rel.type || '相关');
                    path.setAttribute('data-person1', rel.person1);
                    path.setAttribute('data-person2', rel.person2);
                    
                    // 为连线添加点击事件
                    path.addEventListener('click', (e) => {
                        // 确保只有在非拖拽状态下才显示关系信息
                        if (!nodeIsDragging) {
                            e.stopPropagation();
                            const relType = path.getAttribute('data-rel-type');
                            const person1 = path.getAttribute('data-person1');
                            const person2 = path.getAttribute('data-person2');
                            showRelationshipInfo(person1, person2, relType);
                        }
                    });
                    
                    // 悬停效果
                    path.addEventListener('mouseover', () => {
                        path.setAttribute('stroke', '#4f46e5');
                        path.setAttribute('stroke-width', '2');
                        path.setAttribute('stroke-opacity', '1');
                        polygon.setAttribute('fill', '#4f46e5');
                    });
                    
                    path.addEventListener('mouseout', () => {
                        path.setAttribute('stroke', '#94a3b8');
                        path.setAttribute('stroke-width', '1.2');
                        path.setAttribute('stroke-opacity', '0.7');
                        polygon.setAttribute('fill', '#94a3b8');
                    });
                    
                    linksGroup.appendChild(path);
                    linkElements.push({ path, node1, node2, rel });
                }
            });

            // 显示关系信息的函数
            function showRelationshipInfo(person1, person2, relType) {
                // 创建或获取关系信息提示元素
                let tooltip = document.getElementById('relationship-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'relationship-tooltip';
                    tooltip.className = 'fixed bg-white p-4 rounded-lg shadow-xl z-50 border border-gray-200';
                    tooltip.style.cssText = 'font-size: 14px; max-width: 300px; pointer-events: none;';
                    document.body.appendChild(tooltip);
                }
                
                // 设置提示内容
                tooltip.innerHTML = `
                    <div class="text-center">
                        <div class="font-semibold mb-1">${escapeHtml(person1)}</div>
                        <div class="flex items-center justify-center my-1">
                            <i class="fa fa-long-arrow-right text-primary mx-2"></i>
                            <span class="bg-primary/10 text-primary px-2 py-1 rounded text-sm">${escapeHtml(relType)}</span>
                            <i class="fa fa-long-arrow-right text-primary mx-2"></i>
                        </div>
                        <div class="font-semibold">${escapeHtml(person2)}</div>
                    </div>
                `;
                
                // 根据鼠标位置设置提示位置
                tooltip.style.left = (event.clientX + 10) + 'px';
                tooltip.style.top = (event.clientY - 10) + 'px';
                tooltip.style.display = 'block';
                
                // 添加点击其他区域关闭提示的事件
                setTimeout(() => {
                    function hideTooltip(event) {
                        if (!tooltip.contains(event.target)) {
                            tooltip.style.display = 'none';
                            document.removeEventListener('click', hideTooltip);
                        }
                    }
                    document.addEventListener('click', hideTooltip);
                }, 0);
            }

            // 创建节点组，放在连线组上方
            const nodesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            nodesGroup.setAttribute('class', 'nodes-group');
            svg.appendChild(nodesGroup);
            
            // 存储所有节点元素
            const nodeElements = [];
            
            // 绘制节点 - 优化节点样式
            nodeMap.forEach((nodeData, name) => {
                const person = nodeData.person;
                const { x, y } = nodeData;
                
                // 根据关系数量动态调整节点大小
                const nodeRelationshipCount = links.filter(rel => rel.person1 === name || rel.person2 === name).length;
                const sizeFactor = Math.min(1.3, 0.8 + nodeRelationshipCount * 0.1); // 基于关系数调整大小
                const adjustedRadius = nodeRadius * sizeFactor;
                
                // 根据阵营设置颜色
                let nodeColor = '#94a3b8'; // 默认灰色
                let borderColor = '#64748b';
                
                // 添加调试信息
                console.log('角色:', person.name, '阵营值:', person.alliance, '类型:', typeof person.alliance);
                
                if (person.alliance) {
                    // 使用更宽松的匹配方式，先转换为字符串并转小写
                    const allianceStr = String(person.alliance).toLowerCase();
                    console.log('转换后的阵营字符串:', allianceStr);
                    
                    if (allianceStr.includes('皇后') || allianceStr.includes('皇后阵营')) {
                        nodeColor = '#3b82f6'; // 蓝色
                        borderColor = '#1d4ed8';
                    } else if (allianceStr.includes('甄嬛') || allianceStr.includes('甄嬛阵营')) {
                        nodeColor = '#10b981'; // 绿色
                        borderColor = '#059669';
                    } else if (allianceStr.includes('华妃') || allianceStr.includes('华妃阵营')) {
                        nodeColor = '#f59e0b'; // 橙色
                        borderColor = '#d97706';
                    } else if (allianceStr.includes('皇室') || allianceStr.includes('皇室成员')) {
                        nodeColor = '#ef4444'; // 红色
                        borderColor = '#dc2626';
                    } else {
                        console.log('未匹配到已知阵营:', allianceStr);
                    }
                } else {
                    console.log('角色没有阵营信息:', person.name);
                }
                
                // 创建节点组
                const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                nodeGroup.setAttribute('data-person-id', person.id);
                nodeGroup.setAttribute('data-person-name', person.name);
                
                // 创建节点圆圈 - 使用更柔和的样式
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', adjustedRadius);
                circle.setAttribute('fill', nodeColor);
                circle.setAttribute('fill-opacity', '0.9');
                circle.setAttribute('stroke', borderColor);
                circle.setAttribute('stroke-width', '1.5');
                circle.setAttribute('cursor', 'pointer');
                // 添加阴影效果
                circle.setAttribute('filter', 'drop-shadow(0 2px 6px rgba(0,0,0,0.15))');
                
                // 创建节点文本 - 优化字体样式
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', y);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('font-size', Math.min(11, adjustedRadius * 0.35)); // 根据节点大小调整字体
                text.setAttribute('font-weight', '600');
                text.setAttribute('fill', 'white');
                text.setAttribute('stroke', 'none');
                text.setAttribute('pointer-events', 'none');
                
                // 更智能的文本截断
                const maxChars = Math.floor(adjustedRadius * 0.6);
                text.textContent = name.length > maxChars ? name.substring(0, maxChars) + '...' : name;
                
                // 添加到组
                nodeGroup.appendChild(circle);
                nodeGroup.appendChild(text);
                
                // 点击事件 - 显示角色详情，但隐藏操作按钮
                // 确保拖拽和点击事件正确分离
                let clickTimer;
                
                nodeGroup.addEventListener('mousedown', (e) => {
                    if (e.target === circle || e.target === text) {
                        // 开始拖拽时不设置点击定时器
                        if (nodeIsDragging) {
                            return;
                        }
                        
                        // 为点击设置定时器，如果在短时间内释放鼠标，则认为是点击
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                        }, 200); // 200ms作为区分点击和拖拽的阈值
                    }
                });
                
                nodeGroup.addEventListener('mouseup', () => {
                    // 如果点击定时器存在，说明是点击而非拖拽
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        // 只有真正的点击操作才显示详情
                        showPersonDetails();
                    }
                });
                
                // 独立的显示详情函数，仅在真正的点击事件触发
                async function showPersonDetails() {
                    try {
                        // 添加调试信息，确保使用正确的角色名称
                        console.log('查询角色详情:', name, person);
                        const response = await fetch(`${BASE_URL}/name/${encodeURIComponent(name)}`);
                        if (response.ok) {
                            const personDetail = await response.json();
                            console.log('获取到的角色详情:', personDetail);
                            openPersonDetails(personDetail);
                            // 隐藏操作按钮
                        } else {
                            console.error('获取角色详情失败，状态码:', response.status);
                            showNotification('错误', `获取角色详情失败: ${response.status}`, 'error');
                        }
                    } catch (error) {
                        console.error('获取角色详情异常:', error);
                        showNotification('错误', '获取角色详情失败', 'error');
                    }
                }
                
                // 拖拽功能 - 允许用户调整节点位置
                let nodeIsDragging = false;
                let dragOffset = { x: 0, y: 0 };
                
                nodeGroup.addEventListener('mousedown', (e) => {
                    if (e.target === circle || e.target === text) {
                        e.stopPropagation();
                        nodeIsDragging = true;
                        const rect = svg.getBoundingClientRect();
                        dragOffset.x = e.clientX - rect.left - parseFloat(circle.getAttribute('cx'));
                        dragOffset.y = e.clientY - rect.top - parseFloat(circle.getAttribute('cy'));
                        nodeGroup.style.cursor = 'grabbing';
                        circle.setAttribute('fill-opacity', '1');
                        circle.setAttribute('stroke-width', '3');
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (nodeIsDragging) {
                        e.preventDefault();
                        const rect = svg.getBoundingClientRect();
                        let newX = e.clientX - rect.left - dragOffset.x;
                        let newY = e.clientY - rect.top - dragOffset.y;
                        
                        // 边界检查
                        newX = Math.max(graphPadding + adjustedRadius, Math.min(containerWidth - graphPadding - adjustedRadius, newX));
                        newY = Math.max(graphPadding + adjustedRadius, Math.min(containerHeight - graphPadding - adjustedRadius, newY));
                        
                        // 更新节点位置
                        circle.setAttribute('cx', newX);
                        circle.setAttribute('cy', newY);
                        text.setAttribute('x', newX);
                        text.setAttribute('y', newY);
                        
                        // 更新数据
                        nodeData.x = newX;
                        nodeData.y = newY;
                        
                        // 更新连接到该节点的所有连线
                        linkElements.forEach(link => {
                            updateLinkPath(link);
                        });
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    if (nodeIsDragging) {
                        nodeIsDragging = false;
                        nodeGroup.style.cursor = 'pointer';
                        circle.setAttribute('fill-opacity', '0.9');
                        circle.setAttribute('stroke-width', '1.5');
                        // 确保拖拽结束后不会触发信息显示，不执行任何额外操作
                    }
                });
                
                // 悬停效果 - 更明显的放大和高亮效果，保持阵营颜色一致
                nodeGroup.addEventListener('mouseover', () => {
                    if (!nodeIsDragging) {
                        circle.setAttribute('r', adjustedRadius + 3);
                        circle.setAttribute('fill-opacity', '1');
                        // 悬停时略微加深边框颜色
                        const currentBorderColor = circle.getAttribute('stroke');
                        if (currentBorderColor === '#1d4ed8') { // 皇后阵营
                            circle.setAttribute('stroke', '#1e40af');
                        } else if (currentBorderColor === '#059669') { // 甄嬛阵营
                            circle.setAttribute('stroke', '#047857');
                        } else if (currentBorderColor === '#d97706') { // 华妃阵营
                            circle.setAttribute('stroke', '#b45309');
                        } else if (currentBorderColor === '#dc2626') { // 皇室成员
                            circle.setAttribute('stroke', '#b91c1c');
                        } else {
                            circle.setAttribute('stroke', '#475569');
                        }
                        circle.setAttribute('stroke-width', '2.5');
                        text.setAttribute('font-size', Math.min(12, adjustedRadius * 0.35 + 0.5));
                        text.setAttribute('font-weight', 'bold');
                    }
                });
                
                nodeGroup.addEventListener('mouseout', () => {
                    if (!nodeIsDragging) {
                        circle.setAttribute('r', adjustedRadius);
                        circle.setAttribute('fill-opacity', '0.9');
                        // 恢复原始边框颜色
                        circle.setAttribute('stroke', borderColor);
                        circle.setAttribute('stroke-width', '1.5');
                        text.setAttribute('font-size', Math.min(11, adjustedRadius * 0.35));
                        text.setAttribute('font-weight', '600');
                    }
                });
                
                nodesGroup.appendChild(nodeGroup);
                nodeElements.push({ nodeGroup, circle, text, nodeData });
            });
            
            // 更新连线路径的函数
            function updateLinkPath(link) {
                const { path, node1, node2, rel } = link;
                
                // 计算连线方向和距离
                const dx = node2.x - node1.x;
                const dy = node2.y - node1.y;
                const distance = Math.sqrt(dx * dx + dy * dy) || 0.1;
                
                // 获取节点半径（可能因为关系数量不同而不同）
                const node1Radius = nodeMap.get(rel.person1).person ? nodeRadius * Math.min(1.3, 0.8 + links.filter(r => r.person1 === rel.person1 || r.person2 === rel.person1).length * 0.1) : nodeRadius;
                const node2Radius = nodeMap.get(rel.person2).person ? nodeRadius * Math.min(1.3, 0.8 + links.filter(r => r.person1 === rel.person2 || r.person2 === rel.person2).length * 0.1) : nodeRadius;
                
                // 计算线条终点位置，避免直接连接到节点中心
                const startX = node1.x + (dx / distance) * node1Radius;
                const startY = node1.y + (dy / distance) * node1Radius;
                const endX = node2.x - (dx / distance) * node2Radius;
                const endY = node2.y - (dy / distance) * node2Radius;
                
                // 添加轻微的弯曲效果
                const midX = (startX + endX) / 2 + (Math.random() - 0.5) * 10;
                const midY = (startY + endY) / 2 + (Math.random() - 0.5) * 10;
                const pathData = `M ${startX} ${startY} Q ${midX} ${midY} ${endX} ${endY}`;
                
                path.setAttribute('d', pathData);
            }
            
            // 添加简单的动画效果 - 让节点有一个进入动画
            nodeElements.forEach((nodeElement, index) => {
                const { circle, text } = nodeElement;
                const originalRadius = parseFloat(circle.getAttribute('r'));
                const originalFontSize = text.getAttribute('font-size');
                
                // 初始状态
                circle.setAttribute('r', 0);
                text.setAttribute('font-size', '0');
                text.setAttribute('opacity', '0');
                
                // 动画
                setTimeout(() => {
                    // 使用CSS动画
                    circle.style.transition = 'r 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    text.style.transition = 'font-size 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s ease-in-out';
                    
                    circle.setAttribute('r', originalRadius);
                    text.setAttribute('font-size', originalFontSize);
                    text.setAttribute('opacity', '1');
                }, index * 20); // 错开动画时间
            });
            
            // 添加简单的连线动画
            linkElements.forEach((link, index) => {
                const { path } = link;
                
                // 获取路径长度
                const pathLength = path.getTotalLength();
                
                // 初始状态
                path.style.transition = 'none';
                path.style.strokeDasharray = pathLength;
                path.style.strokeDashoffset = pathLength;
                path.style.opacity = '0';
                
                // 触发重排
                path.getBoundingClientRect();
                
                // 设置动画
                setTimeout(() => {
                    path.style.transition = 'stroke-dashoffset 1s ease-in-out, opacity 0.5s ease-in-out';
                    path.style.strokeDashoffset = '0';
                    path.style.opacity = '0.7';
                }, 300 + index * 10); // 稍晚于节点动画开始
            });
        }

        // 生成模拟关系数据
        function generateMockRelationships(persons) {
            const relationships = [];
            const relationshipTypes = ['朋友', '敌人', '家人', '盟友', '对手', '同事'];
            
            // 为每个角色生成一些关系
            persons.forEach((person, index) => {
                // 为每个角色生成1-3个关系
                const relCount = Math.floor(Math.random() * 3) + 1;
                
                for (let i = 0; i < relCount; i++) {
                    // 选择一个不同的角色
                    let targetIndex;
                    do {
                        targetIndex = Math.floor(Math.random() * persons.length);
                    } while (targetIndex === index);
                    
                    const targetPerson = persons[targetIndex];
                    const relType = relationshipTypes[Math.floor(Math.random() * relationshipTypes.length)];
                    
                    // 检查关系是否已存在
                    const existing = relationships.some(rel => 
                        (rel.person1 === person.name && rel.person2 === targetPerson.name) ||
                        (rel.person1 === targetPerson.name && rel.person2 === person.name)
                    );
                    
                    if (!existing) {
                        relationships.push({
                            person1: person.name,
                            person2: targetPerson.name,
                            type: relType
                        });
                    }
                }
            });
            
            return relationships;
        }



    // 初始化聊天记录功能
    function initMessages() {
        console.log('初始化聊天记录功能...');
        
        // 初始化选项卡切换 - 添加安全检查
        const tabAllMessages = document.getElementById('tab-all-messages');
        const tabPersonMessages = document.getElementById('tab-person-messages');
        const tabDialogue = document.getElementById('tab-dialogue');
        const tabSceneMessages = document.getElementById('tab-scene-messages');
        
        if (tabAllMessages && showMessagesTab) {
            tabAllMessages.addEventListener('click', () => showMessagesTab('all-messages-content'));
        }
        if (tabPersonMessages && showMessagesTab) {
            tabPersonMessages.addEventListener('click', () => showMessagesTab('person-messages-content'));
        }
        if (tabDialogue && showMessagesTab) {
            tabDialogue.addEventListener('click', () => showMessagesTab('dialogue-content'));
        }
        if (tabSceneMessages && showMessagesTab && loadScenesList) {
            tabSceneMessages.addEventListener('click', () => {
                showMessagesTab('scene-messages-content');
                // 切换到场景标签时自动加载场景列表
                loadScenesList();
            });
        }

        // 初始化查询按钮事件 - 添加安全检查
        const getAllMessagesBtn = document.getElementById('get-all-messages-btn');
        const getPersonMessagesBtn = document.getElementById('get-person-messages-btn');
        const getDialogueBtn = document.getElementById('get-dialogue-btn');
        
        if (getAllMessagesBtn && getAllMessages) {
            getAllMessagesBtn.addEventListener('click', getAllMessages);
        }
        if (getPersonMessagesBtn && getPersonMessages) {
            getPersonMessagesBtn.addEventListener('click', getPersonMessages);
        }
        if (getDialogueBtn && getDialogue) {
            getDialogueBtn.addEventListener('click', getDialogue);
        }

        // 添加清除场景选择事件 - 添加安全检查
        const clearSelectedScene = document.getElementById('clear-selected-scene');
        if (clearSelectedScene && clearSceneSelection) {
            clearSelectedScene.addEventListener('click', clearSceneSelection);
        }

        // 添加回车键查询支持 - 添加安全检查
        const personNameInput = document.getElementById('person-name-input');
        const dialoguePerson1 = document.getElementById('dialogue-person1');
        const dialoguePerson2 = document.getElementById('dialogue-person2');
        
        if (personNameInput && getPersonMessages) {
            personNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') getPersonMessages();
            });
        }
        if (dialoguePerson1 && getDialogue) {
            dialoguePerson1.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') getDialogue();
            });
        }
        if (dialoguePerson2 && getDialogue) {
            dialoguePerson2.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') getDialogue();
            });
        }

        // 优化版本的场景搜索功能已移至initSceneSearch函数，此函数不再使用

        // 初始化时加载场景列表
        loadScenesList();
    }

    // 搜索场景函数 - 使用数据库模糊查询
    window.searchScenes = function(keyword) {
        console.log('搜索场景函数被调用，关键字:', keyword);
        
        // 获取必要的DOM元素
        const searchResults = document.getElementById('search-results');
        const searchResultsList = document.getElementById('search-results-list');
        const scenesLoading = document.getElementById('scenes-loading');
        const scenesList = document.getElementById('scenes-list');

        // 确保DOM元素存在
        if (!searchResults || !searchResultsList || !scenesLoading) {
            console.error('搜索功能所需的DOM元素不存在');
            return;
        }

        // 处理空关键字情况
        const trimmedKeyword = keyword.trim();
        if (!trimmedKeyword) {
            console.log('空关键字，显示空状态');
            searchResultsList.innerHTML = '';
            scenesLoading.classList.add('hidden');
            searchResults.classList.add('hidden');
            return;
        }

        // 显示加载状态
        searchResultsList.innerHTML = '';
        scenesLoading.classList.remove('hidden');
        searchResults.classList.remove('hidden');
        if (scenesList) scenesList.classList.add('hidden');

        // 调用后端API进行模糊查询
        console.log('开始调用后端API进行模糊查询...');
        fetch(`/api/messages/scenes/search?keyword=${encodeURIComponent(keyword)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API查询成功，返回结果数量:', data.length || 0);
            
            // 隐藏加载状态
            scenesLoading.classList.add('hidden');
            
            // 处理返回的场景数据
            let scenes = [];
            
            // 检查返回数据格式并标准化
            if (Array.isArray(data)) {
                scenes = data;
            } else if (data && Array.isArray(data.scenes)) {
                scenes = data.scenes;
            } else if (data && Array.isArray(data.results)) {
                scenes = data.results;
            }
            
            // 去重处理和JSON解析
            console.log('原始数据数量:', scenes.length);
            const uniqueScenes = [];
            const sceneSet = new Set();
            
            scenes.forEach(item => {
                // 处理不同类型的输入项
                let sceneName = item;
                
                // 如果是字符串，检查是否为JSON格式
                if (typeof item === 'string') {
                    // 尝试解析可能的JSON字符串
                    if (item.startsWith('{') && item.includes('scene')) {
                        try {
                            const parsed = JSON.parse(item);
                            sceneName = parsed.scene || item;
                        } catch (e) {
                            // 解析失败，使用原始字符串
                        }
                    }
                } 
                // 如果是对象，尝试获取scene属性
                else if (typeof item === 'object' && item !== null) {
                    sceneName = item.scene || item.name || item.sceneName || item.title || String(item);
                }
                
                // 确保是字符串并去除前后空白
                sceneName = String(sceneName || '').trim();
                
                if (sceneName && !sceneSet.has(sceneName)) {
                    sceneSet.add(sceneName);
                    uniqueScenes.push(sceneName); // 直接存储场景名称字符串
                }
            });
            
            scenes = uniqueScenes;
            console.log('去重后场景数量:', scenes.length);
            
            // 显示结果
            if (scenes.length === 0) {
                searchResultsList.innerHTML = `
                    <div class="p-4 text-center text-gray-500 text-sm bg-gray-50 rounded-lg m-2">
                        未找到匹配的场景
                    </div>
                `;
            } else {
                // 清空列表
                searchResultsList.innerHTML = '';
                
                // 添加结果项
                scenes.forEach(sceneName => {
                    // 确保sceneName是字符串
                    sceneName = String(sceneName || '').trim();
                    
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left bg-white border border-gray-200 rounded-lg p-3 mb-2 hover:bg-gray-50 transition-colors card-shadow';
                    btn.innerHTML = `
                        <div class="flex items-center">
                            <i class="fa fa-map-marker text-primary mr-3"></i>
                            <span class="text-sm font-medium">${sceneName}</span>
                        </div>
                    `;
                    
                    // 点击事件
                    btn.onclick = function() {
                        console.log('选择场景:', sceneName);
                        
                        // 调用selectScene函数
                        if (window.selectScene) {
                            selectScene(sceneName);
                        } else {
                            console.warn('selectScene函数未定义');
                            // 简单处理选中状态
                            if (document.getElementById('selected-scene-name')) {
                                document.getElementById('selected-scene-name').textContent = sceneName;
                                document.getElementById('selected-scene-info').classList.remove('hidden');
                            }
                        }
                        
                        // 隐藏搜索结果
                        searchResults.classList.add('hidden');
                        if (scenesList) scenesList.classList.remove('hidden');
                        
                        // 清空搜索框
                        const input = document.getElementById('scene-search-input');
                        if (input) input.value = '';
                    };
                    
                    searchResultsList.appendChild(btn);
                });
            }
        })
        .catch(error => {
            console.error('API调用失败:', error);
            
            // 隐藏加载状态
            scenesLoading.classList.add('hidden');
            
            // 显示错误信息
            searchResultsList.innerHTML = `
                    <div class="p-4 text-center text-red-500 text-sm bg-gray-50 rounded-lg m-2">
                        搜索失败：${error.message || '无法连接到服务器'}
                    </div>
                `;
        });
    }

    // 加载场景列表
    async function loadScenesList() {
        const scenesList = document.getElementById('scenes-list');
        const scenesLoading = document.getElementById('scenes-loading');

        // 显示加载状态
        scenesLoading.classList.remove('hidden');
        
        // 短暂显示加载后，显示搜索提示
        setTimeout(() => {
            scenesLoading.classList.add('hidden');
            scenesList.innerHTML = `
                <div class="col-span-full p-6 bg-gray-50 rounded-lg text-center text-gray-500">
                    <i class="fa fa-search text-3xl mb-3 text-gray-400"></i>
                    <p class="text-sm">请在上方搜索框中输入场景关键词进行搜索</p>
                    <p class="text-xs mt-1 text-gray-400">输入部分文字即可匹配相关场景</p>
                </div>
            `;
        }, 500);
    }

    // 选择场景
    function selectScene(sceneName) {
        // 确保只显示纯文本场景名，去除JSON格式
        let displayName = String(sceneName || '').trim();
        
        // 如果是JSON格式字符串，尝试解析
        if (displayName.includes('{') && displayName.includes('scene')) {
            try {
                const parsed = JSON.parse(displayName);
                displayName = String(parsed.scene || displayName).trim();
            } catch (e) {
                // 解析失败，使用原始字符串
            }
        }
        
        document.getElementById('selected-scene-name').textContent = displayName;
        document.getElementById('selected-scene-info').classList.remove('hidden');
        
        // 选择场景后立即加载并显示该场景的消息
        if (window.getSceneMessages) {
            getSceneMessages(displayName);
        }
    }

    // 清除场景选择
    function clearSceneSelection() {
        // 重置所有场景按钮的样式
        document.querySelectorAll('#scenes-list button').forEach(btn => {
            btn.classList.remove('bg-primary', 'text-white', 'border-primary', 'shadow-md');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-200', 'hover:bg-gray-50');
            const marker = btn.querySelector('.fa-map-marker');
            if (marker) {
                marker.classList.remove('text-white');
                marker.classList.add('text-primary');
            }
        });

        // 重置界面状态
        document.getElementById('selected-scene-info').classList.add('hidden');
        document.getElementById('scene-messages-container').classList.add('hidden');
        document.getElementById('scene-messages-empty').classList.add('hidden');
        document.getElementById('scene-messages-loading').classList.add('hidden');
        document.getElementById('scene-messages-initial').classList.remove('hidden');
    }

    // 显示消息选项卡
    function showMessagesTab(tabId) {
        // 隐藏所有消息内容
        document.querySelectorAll('.messages-content').forEach(content => {
            content.classList.add('hidden');
        });

        // 显示指定的消息内容
        document.getElementById(tabId).classList.remove('hidden');

        // 更新选项卡状态
        document.querySelectorAll('#messages-section .border-b button').forEach(tab => {
            tab.classList.remove('border-primary', 'text-primary');
            tab.classList.add('border-transparent', 'text-gray-500');
        });

        // 激活当前选项卡
        const tabButtonId = tabId.replace('-content', '');
        document.getElementById(tabButtonId)?.classList.remove('border-transparent', 'text-gray-500');
        document.getElementById(tabButtonId)?.classList.add('border-primary', 'text-primary');
    }

    // 获取所有发言
    async function getAllMessages() {
        const container = document.getElementById('all-messages-container');
        const loading = document.getElementById('all-messages-loading');
        const empty = document.getElementById('all-messages-empty');

        // 显示加载状态
        container.innerHTML = '';
        container.classList.add('hidden');
        empty.classList.add('hidden');
        loading.classList.remove('hidden');

        try {
            const response = await fetch('/api/messages/all');
            const messages = await response.json();

            // 隐藏加载状态
            loading.classList.add('hidden');

            if (messages.length === 0) {
                empty.classList.remove('hidden');
            } else {
                container.classList.remove('hidden');
                renderMessages(container, messages, false);
            }
        } catch (error) {
            loading.classList.add('hidden');
            showNotification('获取失败', '加载所有发言时发生错误', 'error');
            console.error('获取所有发言失败:', error);
        }
    }

    // 获取角色发言
    async function getPersonMessages() {
        const name = document.getElementById('person-name-input').value.trim();
        if (!name) {
            showNotification('提示', '请输入角色名称', 'info');
            return;
        }

        const container = document.getElementById('person-messages-container');
        const loading = document.getElementById('person-messages-loading');
        const empty = document.getElementById('person-messages-empty');

        // 显示加载状态
        container.innerHTML = '';
        container.classList.add('hidden');
        empty.classList.add('hidden');
        loading.classList.remove('hidden');

        try {
            const response = await fetch(`/api/messages/person/${encodeURIComponent(name)}`);

            if (!response.ok) {
                throw new Error('获取角色发言失败');
            }

            const messages = await response.json();

            // 隐藏加载状态
            loading.classList.add('hidden');

            if (messages.length === 0) {
                empty.classList.remove('hidden');
            } else {
                container.classList.remove('hidden');
                renderMessages(container, messages, false);
            }
        } catch (error) {
            loading.classList.add('hidden');
            showNotification('获取失败', `加载${name}的发言时发生错误`, 'error');
            console.error('获取角色发言失败:', error);
        }
    }

    // 获取角色对话
    async function getDialogue() {
        const person1 = document.getElementById('dialogue-person1').value.trim();
        const person2 = document.getElementById('dialogue-person2').value.trim();

        if (!person1 || !person2) {
            showNotification('提示', '请输入两个角色的名称', 'info');
            return;
        }

        const container = document.getElementById('dialogue-container');
        const loading = document.getElementById('dialogue-loading');
        const empty = document.getElementById('dialogue-empty');

        // 显示加载状态
        container.innerHTML = '';
        container.classList.add('hidden');
        empty.classList.add('hidden');
        loading.classList.remove('hidden');

        try {
            const response = await fetch(`/api/messages/dialogue/${encodeURIComponent(person1)}/${encodeURIComponent(person2)}`);

            if (!response.ok) {
                throw new Error('获取对话失败');
            }

            const messages = await response.json();

            // 隐藏加载状态
            loading.classList.add('hidden');

            if (messages.length === 0) {
                empty.classList.remove('hidden');
            } else {
                container.classList.remove('hidden');
                renderDialogue(container, messages, person1, person2);
            }
        } catch (error) {
            loading.classList.add('hidden');
            showNotification('获取失败', `加载${person1}和${person2}的对话时发生错误`, 'error');
            console.error('获取对话失败:', error);
        }
    }

    // 获取场景发言
    async function getSceneMessages(sceneName) {
        if (!sceneName || sceneName.trim() === '') {
            showNotification('提示', '请选择场景名称', 'info');
            return;
        }

        // 获取主要容器和红色框框区域
        const container = document.getElementById('scene-messages-container');
        // 获取红色框框区域的DOM元素（假设是右侧的主内容区域）
        const mainContentArea = document.querySelector('#scene-messages-content .border.border-gray-200.rounded-lg');
        
        const loading = document.getElementById('scene-messages-loading');
        const empty = document.getElementById('scene-messages-empty');
        const initial = document.getElementById('scene-messages-initial');

        // 显示加载状态
        if (container) container.innerHTML = '';
        if (mainContentArea) {
            mainContentArea.innerHTML = '<div class="text-center p-10 text-gray-500">加载中...</div>';
            mainContentArea.style.backgroundColor = '#e6f7ff'; // 临时设置天空蓝背景
        }
        if (container) container.classList.add('hidden');
        if (empty) empty.classList.add('hidden');
        if (initial) initial.classList.add('hidden');
        if (loading) loading.classList.remove('hidden');

        try {
            const response = await fetch(`/api/messages/scene/${encodeURIComponent(sceneName)}`);

            if (!response.ok) {
                throw new Error('获取场景发言失败');
            }

            const messages = await response.json();

            // 隐藏加载状态
            if (loading) loading.classList.add('hidden');

            if (messages.length === 0) {
                if (empty) empty.classList.remove('hidden');
                if (mainContentArea) {
                    mainContentArea.innerHTML = '<div class="text-center p-10 text-gray-500">该场景暂无发言记录</div>';
                    mainContentArea.style.backgroundColor = '#e6f7ff'; // 设置天空蓝背景
                }
            } else {
                // 使用红色框框区域显示消息
                if (mainContentArea) {
                    // 设置天空蓝背景
                    mainContentArea.style.backgroundColor = '#e6f7ff';
                    // 清空并渲染消息
                    mainContentArea.innerHTML = '';
                    
                    // 按时间顺序排序所有消息
                    const sortedMessages = messages.sort((a, b) => 
                        new Date(a.sendTime) - new Date(b.sendTime)
                    );
                    
                    // 渲染每条消息
                    sortedMessages.forEach(message => {
                        const messageCard = document.createElement('div');
                        messageCard.className = 'mb-3 p-4 border-b border-sky-200 last:border-0';
                        
                        const formattedTime = new Date(message.sendTime).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        messageCard.innerHTML = `
                            <div class="flex items-start">
                                <span class="font-semibold text-sky-700 mr-2">${escapeHtml(message.fromUserName)}:</span>
                                <span class="text-gray-800">${escapeHtml(message.content)}</span>
                            </div>
                            <div class="mt-1 text-xs text-gray-500">
                                ${formattedTime}
                            </div>
                        `;
                        
                        mainContentArea.appendChild(messageCard);
                    });
                }
                
                if (container) {
                    container.classList.remove('hidden');
                    renderSceneMessages(container, messages, sceneName);
                }
            }
        } catch (error) {
            if (loading) loading.classList.add('hidden');
            if (initial) initial.classList.remove('hidden');
            if (mainContentArea) {
                mainContentArea.innerHTML = `<div class="text-center p-10 text-red-500">加载失败: ${error.message}</div>`;
                mainContentArea.style.backgroundColor = '#e6f7ff'; // 设置天空蓝背景
            }
            showNotification('获取失败', `加载${sceneName}场景的发言时发生错误`, 'error');
            console.error('获取场景发言失败:', error);
        }
    }

    // 渲染场景消息（按角色分组显示）
    function renderSceneMessages(container, messages, sceneName) {
        container.innerHTML = '';

        // 按时间顺序排序所有消息
        const sortedMessages = messages.sort((a, b) => 
            new Date(a.sendTime) - new Date(b.sendTime)
        );

        // 直接渲染每条消息，格式为"<姓名>: <发言内容>"，使用天空蓝背景
        sortedMessages.forEach(message => {
            // 不包含_id字段，只显示姓名和内容
            const messageCard = document.createElement('div');
            // 设置天空蓝背景和适当的样式
            messageCard.className = 'mb-3 bg-sky-50 rounded-lg p-4 shadow-sm border border-sky-100';
            
            const formattedTime = new Date(message.sendTime).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // 只显示"姓名: 内容"格式，并添加时间
            messageCard.innerHTML = `
                <div class="flex items-start">
                    <span class="font-semibold text-sky-700 mr-2">${escapeHtml(message.fromUserName)}:</span>
                    <span class="text-gray-800">${escapeHtml(message.content)}</span>
                </div>
                <div class="mt-1 text-xs text-gray-500">
                    ${formattedTime}
                </div>
            `;
            
            container.appendChild(messageCard);
        });
    }

    // 渲染消息列表（普通视图）
    function renderMessages(container, messages, isSceneView = false) {
        container.innerHTML = '';

        messages.forEach(message => {
            const messageCard = document.createElement('div');
            messageCard.className = 'bg-white rounded-xl p-5 shadow-sm border border-gray-200 hover:shadow-md transition-all duration-300 mb-4';

            const formattedTime = new Date(message.sendTime).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            messageCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                                <i class="fa fa-user"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">${escapeHtml(message.fromUserName)}</h4>
                                ${message.toUserName ? `
                                <div class="text-sm text-gray-500 flex items-center">
                                    <i class="fa fa-arrow-right text-xs mr-1"></i>
                                    <span>${escapeHtml(message.toUserName)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <span class="text-xs text-gray-500">${formattedTime}</span>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <p class="text-gray-800">${escapeHtml(message.content)}</p>
                    </div>
                    ${message.scene ? `
                    <div class="mt-3 text-xs text-primary flex items-center">
                        <i class="fa fa-map-marker mr-1"></i>
                        <span>${escapeHtml(message.scene)}</span>
                    </div>
                    ` : ''}
                `;

            container.appendChild(messageCard);
        });
    }

    // 渲染对话消息（聊天界面）
    function renderDialogue(container, messages, person1, person2) {
        container.innerHTML = '';

        // 添加对话标题
        const header = document.createElement('div');
        header.className = 'text-center mb-8 p-4 bg-white rounded-xl shadow-sm border border-gray-200';
        header.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 flex items-center justify-center space-x-4 mb-2">
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full">${escapeHtml(person1)}</span>
                    <i class="fa fa-exchange text-gray-400"></i>
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full">${escapeHtml(person2)}</span>
                </h3>
                <p class="text-sm text-gray-500">共 ${messages.length} 条对话记录</p>
            `;
        container.appendChild(header);

        // 创建消息容器
        const messagesWrapper = document.createElement('div');
        messagesWrapper.className = 'space-y-4';

        // 按时间排序
        messages.sort((a, b) => new Date(a.sendTime) - new Date(b.sendTime));

        messages.forEach(message => {
            const isFromPerson1 = message.fromUserName === person1;
            const messageBubble = document.createElement('div');
            messageBubble.className = isFromPerson1 ? 'flex justify-start' : 'flex justify-end';

            const formattedTime = new Date(message.sendTime).toLocaleString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageBubble.innerHTML = `
                    <div class="max-w-[75%] ${isFromPerson1 ? 'bg-blue-50 border border-blue-100 rounded-tl-none' : 'bg-green-50 border border-green-100 rounded-tr-none'} rounded-xl p-4">
                        <div class="font-medium mb-1 text-sm ${isFromPerson1 ? 'text-blue-700' : 'text-green-700'}">
                            ${escapeHtml(message.fromUserName)}
                        </div>
                        <p class="mb-2 text-gray-800">${escapeHtml(message.content)}</p>
                        <div class="text-right text-xs ${isFromPerson1 ? 'text-blue-500' : 'text-green-500'}">
                            ${formattedTime}
                        </div>
                    </div>
                `;

            messagesWrapper.appendChild(messageBubble);
        });

        container.appendChild(messagesWrapper);
    }

    // HTML转义函数
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 初始化场景搜索功能
    function initSceneSearch() {
        console.log('初始化场景搜索功能...');
        const sceneSearchInput = document.getElementById('scene-search-input');
        const searchResults = document.getElementById('search-results');
        const searchResultsList = document.getElementById('search-results-list');
        
        // 检查必要的DOM元素
        if (!sceneSearchInput || !searchResults || !searchResultsList) {
            console.error('缺少必要的DOM元素，无法初始化场景搜索功能');
            return;
        }
        
        console.log('DOM元素检查通过，开始绑定事件监听器');
        
        // 聚焦时显示所有场景
        function handleSceneFocus() {
            console.log('场景搜索框获得焦点，加载所有场景');
            searchResults.classList.remove('hidden');
            searchResultsList.innerHTML = '<div class="text-center p-4 text-gray-500 text-sm bg-gray-50 rounded-lg m-2">加载中...</div>';
            
            fetch('/api/messages/scenes')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误，状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(scenes => {
                    console.log('获取场景列表成功，数量:', scenes.length);
                    
                    // 处理不同格式的响应数据
                    let sceneList = [];
                    if (Array.isArray(scenes)) {
                        sceneList = scenes;
                    } else if (scenes && Array.isArray(scenes.scenes)) {
                        sceneList = scenes.scenes;
                    }
                    
                    // 过滤和去重，同时提取纯文本场景名称
                    sceneList = sceneList.filter(scene => scene)
                                         .map(scene => {
                                             let sceneName = String(scene || '').trim();
                                             // 尝试解析JSON字符串
                                             try {
                                                 if (sceneName.startsWith('{')) {
                                                     const parsedScene = JSON.parse(sceneName);
                                                     if (parsedScene.scene) {
                                                         return parsedScene.scene.trim();
                                                     }
                                                 }
                                             } catch (e) {
                                                 // 解析失败，尝试字符串提取
                                                 if (sceneName.includes('"scene":"')) {
                                                     sceneName = sceneName.split('"scene":"')[1]?.split('"')[0] || sceneName;
                                                 }
                                             }
                                             // 清理可能的花括号和引号
                                             sceneName = sceneName.replace(/[{}]/g, '').replace(/"/g, '').trim();
                                             return sceneName;
                                         })
                                         .filter(sceneName => sceneName !== '')
                                         .filter((sceneName, index, self) => self.indexOf(sceneName) === index);
                    
                    if (sceneList.length > 0) {
                        searchResultsList.innerHTML = '';
                        sceneList.forEach(sceneName => {
                            const sceneItem = document.createElement('button');
                            sceneItem.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 text-sm transition-colors';
                            sceneItem.textContent = sceneName;
                            sceneItem.addEventListener('click', () => {
                                sceneSearchInput.value = sceneName;
                                searchResults.classList.add('hidden');
                                // 确保selectScene函数存在
                                if (typeof selectScene === 'function') {
                                    selectScene(sceneName);
                                }
                            });
                            searchResultsList.appendChild(sceneItem);
                        });
                    } else {
                        searchResultsList.innerHTML = '<div class="text-center py-2 text-gray-500">暂无场景数据</div>';
                    }
                })
                .catch(error => {
                    console.error('加载场景失败:', error);
                    searchResultsList.innerHTML = '<div class="text-center p-4 text-red-500 text-sm bg-gray-50 rounded-lg m-2">加载失败</div>';
                });
        }
        
        // 搜索框输入时的处理逻辑
        function handleSceneInput() {
            const keyword = sceneSearchInput.value.trim();
            console.log('场景搜索框输入内容:', keyword);
            
            if (keyword) {
                searchResults.classList.remove('hidden');
                searchResultsList.innerHTML = '<div class="text-center p-4 text-gray-500 text-sm bg-gray-50 rounded-lg m-2">搜索中...</div>';
                
                fetch(`/api/messages/scenes/search?keyword=${encodeURIComponent(keyword)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP错误，状态码: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(scenes => {
                        console.log('搜索场景成功，结果数量:', scenes.length);
                        
                        // 处理不同格式的响应数据
                        let sceneList = [];
                        if (Array.isArray(scenes)) {
                            sceneList = scenes;
                        } else if (scenes && Array.isArray(scenes.scenes)) {
                            sceneList = scenes.scenes;
                        }
                        
                        // 过滤和去重，同时提取纯文本场景名称
                          sceneList = sceneList.filter(scene => scene)
                                               .map(scene => {
                                                   let sceneName = String(scene || '').trim();
                                                   // 尝试解析JSON字符串
                                                   try {
                                                       if (sceneName.startsWith('{')) {
                                                           const parsedScene = JSON.parse(sceneName);
                                                           if (parsedScene.scene) {
                                                               return parsedScene.scene.trim();
                                                           }
                                                       }
                                                   } catch (e) {
                                                       // 解析失败，尝试字符串提取
                                                       if (sceneName.includes('"scene":"')) {
                                                           sceneName = sceneName.split('"scene":"')[1]?.split('"')[0] || sceneName;
                                                       }
                                                   }
                                                   // 清理可能的花括号和引号
                                                   sceneName = sceneName.replace(/[{}]/g, '').replace(/"/g, '').trim();
                                                   return sceneName;
                                               })
                                               .filter(sceneName => sceneName !== '')
                                               .filter((sceneName, index, self) => self.indexOf(sceneName) === index);
                        
                        if (sceneList.length > 0) {
                            searchResultsList.innerHTML = '';
                            sceneList.forEach(sceneName => {
                                const sceneItem = document.createElement('button');
                                sceneItem.className = 'w-full text-left bg-white border border-gray-200 rounded-lg p-3 mb-2 hover:bg-gray-50 transition-colors card-shadow text-sm';
                                sceneItem.textContent = sceneName;
                                sceneItem.addEventListener('click', () => {
                                    sceneSearchInput.value = sceneName;
                                    searchResults.classList.add('hidden');
                                    // 确保selectScene函数存在
                                    if (typeof selectScene === 'function') {
                                        selectScene(sceneName);
                                    }
                                });
                                searchResultsList.appendChild(sceneItem);
                            });
                        } else {
                            searchResultsList.innerHTML = '<div class="text-center p-4 text-gray-500 text-sm bg-gray-50 rounded-lg m-2">未找到匹配的场景</div>';
                        }
                    })
                    .catch(error => {
                        console.error('搜索场景失败:', error);
                        searchResultsList.innerHTML = '<div class="text-center py-2 text-red-500">搜索失败</div>';
                    });
            } else {
                // 输入框为空时显示所有场景
                handleSceneFocus();
            }
        }
        
        // 绑定事件监听器
        sceneSearchInput.addEventListener('focus', handleSceneFocus);
        sceneSearchInput.addEventListener('input', handleSceneInput);
        
        // 点击页面其他地方关闭搜索结果
        document.addEventListener('click', (e) => {
            if (!sceneSearchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });
    }
    
    // 初始化回到顶部功能
    function initBackToTop() {
        const backToTopButton = document.getElementById('back-to-top');
        
        if (backToTopButton) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopButton.classList.remove('opacity-0', 'invisible');
                    backToTopButton.classList.add('opacity-100', 'visible');
                } else {
                    backToTopButton.classList.remove('opacity-100', 'visible');
                    backToTopButton.classList.add('opacity-0', 'invisible');
                }
            });
            
            backToTopButton.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
        init();
        initMessages();
        initSceneSearch();
        initBackToTop();
    });
</script>
</body>
</html>